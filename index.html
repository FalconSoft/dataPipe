<html>

<head>
  <title>Data Pipe JS</title>
  <script src="./dist/data-pipe.min.js"></script>

</head>

<body>
  <h4>Data Pipe testing page. Do not expect anything here! </h4>

  <button onclick="onButtonClick()">++ Click ++ </button>

  <input id="input" type="file" onchange="fileChange(this.files[0])" />

  <script>
    let result = null;
    let firstChar = '';

    function fileChange(file) {
      if (!file) {
        return;
      }
      firstChar = '';
      result = [];
      const parser = dp.dataPipe().JSONParser();

      iterateChunks(file, chunkText => {
        for (const ch of chunkText) {
          parser.processJsonItems(ch, (itemString, key) => {
            console.log('====>', `'${key}'`, itemString);
            var item = JSON.parse(itemString);
            if (item.id == "2489660416") {
              console.log('s')
            }
            // "2489660416"
            result.push(JSON.parse(itemString))
          });
        }
      });

    }

    function iterateChunks(file, callback) {
      const chunkSize = 1024; // 10 * 64 * 64 * 1024;
      let offset = 0;
      const decoder = new TextDecoder();
      const fr = new FileReader();
      fr.onload = () => {
        const view = new Uint8Array(fr.result);
        const text = decoder.decode(view);
        callback(text);

        offset += chunkSize;
        seek();
      }
      fr.onerror = (err) => {
        console.log(err)
      };

      seek();

      function seek() {
        if (offset >= file.size) {
          console.log('==> done ==>', result)

          return;
        }

        const slice = file.slice(offset, offset + chunkSize);
        fr.readAsArrayBuffer(slice)
      }
    }

    function onButtonClick() {
      // const iterator = dp.dataPipe()
      //   .jsonParseIterator('{v:{vi:test}, arr:{vi:test2}}');

      // for (let v of iterator) {
      //   console.log(v);
      // }
      // console.log(Array.from(iterator));
      return;

      // const mapFn = r => ({ val1: r });
      // const fdFn = (arr) => dp.dataPipe(arr.map(mapFn)).getFieldsInfo();

      // const data = fdFn([new Date(2001, 1, 1), new Date()]);

      const array = ['2021-05-01', null, '2021-05-01'];
      data = dp
        .dataPipe(array)
        .getFieldsInfo();

      console.log('==>', dp.dataPipe().rtrim('net.', '.'))

      // fetch("https://restcountries.eu/rest/v2/regionalbloc/eu")
      // .then(r => {
      //   r.json().then(items => {
      //     console.log('==>', items, dp.dataPipe(items).getFieldsInfo());
      //   });
      // })

    }

    onButtonClick();

    // fetch("https://raw.githubusercontent.com/FalconSoft/sample-data/master/CSV/sample-testing-data-100.csv")
    //   .then(r => {
    //     r.text().then(text => {
    //       const items = dp.dataPipe().fromCsv(text).toArray();
    //       console.log('==>', items, dp.dataPipe(items).getFieldDescriptions());
    //     });
    //   })

    // onButtonClick();

  </script>
</body>

</html>