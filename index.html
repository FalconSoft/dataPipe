<html>

<head>
  <title>Data Pipe JS</title>
  <script src="./dist/data-pipe.min.js"></script>

</head>

<body>
  <h4>Data Pipe testing page. Do not expect anything here! </h4>

  <button onclick="onButtonClick()">++ Click ++ </button>

  <input id="input" type="file" onchange="fileChange(this.files[0])" />

  <script>
    let result = null;
    let firstChar = '';

    function fileChange(file) {
      if (!file) {
        return;
      }
      firstChar = '';
      result = null;
      const parser = dp.dataPipe().JSONParser();

      iterateChunks(file, chunkText => {
        for (const ch of chunkText) {
          if (!firstChar) {
            firstChar = ch;
            result = ch === '[' ? [] : Object.create(null);
            continue;
          }
          parser.processFirstLevel(ch, (itemString, key) => {
            result.push(JSON.parse(itemString))            
          });
        }
      });

    }

    function iterateChunks(file, callback) {
      const chunkSize = 1024; // 10 * 64 * 64 * 1024;
      let offset = 0;
      const decoder = new TextDecoder();
      const fr = new FileReader();
      fr.onload = () => {
        const view = new Uint8Array(fr.result);
        const text = decoder.decode(view);
        callback(text);

        offset += chunkSize;
        seek();
      }
      fr.onerror = (err) => {
        console.log(err)
      };

      seek();

      function seek() {
        if (offset >= file.size) {
          console.log('==> done ==>', result)

          return;
        }

        const slice = file.slice(offset, offset + chunkSize);
        fr.readAsArrayBuffer(slice)
      }
    }

    function onButtonClick() {
      const json = `[{"name":{"common":"Belarus","official":"Republic of Belarus","nativeName":{"bel":{"official":"Рэспубліка Беларусь","common":"Белару́сь"},"rus":{"official":"Республика Беларусь","common":"Беларусь"}}},"tld":[".by"],"cca2":"BY","ccn3":"112","cca3":"BLR","cioc":"BLR","independent":true,"status":"officially-assigned","unMember":true,"currencies":{"BYN":{"name":"Belarusian ruble","symbol":"Br"}},"idd":{"root":"+3","suffixes":["75"]},"capital":["Minsk"],"altSpellings":["BY","Bielaruś","Republic of Belarus","Белоруссия","Республика Белоруссия"],"region":"Europe","subregion":"Eastern Europe","languages":{"bel":"Belarusian","rus":"Russian"},"translations":{"ara":{"official":"جمهورية بيلاروسيا","common":"بيلاروسيا"},"ces":{"official":"Běloruská republika","common":"Bělorusko"},"cym":{"official":"Gweriniaeth Belarws","common":"Belarws"},"deu":{"official":"Republik Belarus","common":"Weißrussland"},"est":{"official":"Valgevene Vabariik","common":"Valgevene"},"fin":{"official":"Valko-Venäjän tasavalta","common":"Valko-Venäjä"},"fra":{"official":"République de Biélorussie","common":"Biélorussie"},"hrv":{"official":"Republika Bjelorusija","common":"Bjelorusija"},"hun":{"official":"Fehérorosz Köztársaság","common":"Fehéroroszország"},"ita":{"official":"Repubblica di Belarus","common":"Bielorussia"},"jpn":{"official":"ベラルーシ共和国","common":"ベラルーシ"},"kor":{"official":"벨라루스 공화국","common":"벨라루스"},"nld":{"official":"Republiek Belarus","common":"Wit-Rusland"},"per":{"official":"جمهوری بلاروس","common":"بلاروس"},"pol":{"official":"Republika Białorusi","common":"Białoruś"},"por":{"official":"República da Bielorrússia","common":"Bielorússia"},"rus":{"official":"Республика Беларусь","common":"Беларусь"},"slk":{"official":"Bieloruská republika","common":"Bielorusko"},"spa":{"official":"República de Belarús","common":"Bielorrusia"},"swe":{"official":"Republiken Vitryssland","common":"Belarus"},"urd":{"official":"جمہوریہ بیلاروس","common":"بیلاروس"},"zho":{"official":"白俄罗斯共和国","common":"白俄罗斯"}},"latlng":[53,28],"landlocked":true,"borders":["LVA","LTU","POL","RUS","UKR"],"area":207600,"demonyms":{"eng":{"f":"Belarusian","m":"Belarusian"},"fra":{"f":"Biélorusse","m":"Biélorusse"}},"flag":"🇧🇾","maps":{"googleMaps":"https://goo.gl/maps/PJUDU3EBPSszCQcu6","openStreetMaps":"https://www.openstreetmap.org/relation/59065"},"population":9398861,"gini":{"2019":25.3},"fifa":"BLR","car":{"signs":["BY"],"side":"right"},"timezones":["UTC+03:00"],"continents":["Europe"],"flags":{"png":"https://flagcdn.com/w320/by.png","svg":"https://flagcdn.com/by.svg"},"coatOfArms":{"png":"https://mainfacts.com/media/images/coats_of_arms/by.png","svg":"https://mainfacts.com/media/images/coats_of_arms/by.svg"},"startOfWeek":"monday","capitalInfo":{"latlng":[53.9,27.57]},"postalCode":{"format":"######","regex":"^(\\d{6})$"}},{"name":{"common":"Slovakia","official":"Slovak Republic","nativeName":{"slk":{"official":"Slovenská republika","common":"Slovensko"}}},"tld":[".sk"],"cca2":"SK","ccn3":"703","cca3":"SVK","cioc":"SVK","independent":true,"status":"officially-assigned","unMember":true,"currencies":{"EUR":{"name":"Euro","symbol":"€"}},"idd":{"root":"+4","suffixes":["21"]},"capital":["Bratislava"],"altSpellings":["SK","Slovak Republic","Slovenská republika"],"region":"Europe","subregion":"Central Europe","languages":{"slk":"Slovak"},"translations":{"ara":{"official":"جمهورية سلوفاكيا","common":"سلوفاكيا"},"ces":{"official":"Slovenská republika","common":"Slovensko"},"cym":{"official":"Slovak Republic","common":"Slovakia"},"deu":{"official":"Slowakische Republik","common":"Slowakei"},"est":{"official":"Slovaki Vabariik","common":"Slovakkia"},"fin":{"official":"Slovakian tasavalta","common":"Slovakia"},"fra":{"official":"République slovaque","common":"Slovaquie"},"hrv":{"official":"slovačka","common":"Slovačka"},"hun":{"official":"Szlovák Köztársaság","common":"Szlovákia"},"ita":{"official":"Repubblica slovacca","common":"Slovacchia"},"jpn":{"official":"スロバキア共和国","common":"スロバキア"},"kor":{"official":"슬로바키아 공화국","common":"슬로바키아"},"nld":{"official":"Slowaakse Republiek","common":"Slowakije"},"per":{"official":"جمهوری اسلواکی","common":"اِسلُواکی"},"pol":{"official":"Republika Słowacka","common":"Słowacja"},"por":{"official":"República Eslovaca","common":"Eslováquia"},"rus":{"official":"Словацкая Республика","common":"Словакия"},"slk":{"official":"Slovenská republika","common":"Slovensko"},"spa":{"official":"República Eslovaca","common":"República Eslovaca"},"swe":{"official":"Republiken Slovakien","common":"Slovakien"},"urd":{"official":"جمہوریہ سلوواکیہ","common":"سلوواکیہ"},"zho":{"official":"斯洛伐克共和国","common":"斯洛伐克"}},"latlng":[48.66666666,19.5],"landlocked":true,"borders":["AUT","CZE","HUN","POL","UKR"],"area":49037,"demonyms":{"eng":{"f":"Slovak","m":"Slovak"},"fra":{"f":"Slovaque","m":"Slovaque"}},"flag":"🇸🇰","maps":{"googleMaps":"https://goo.gl/maps/uNSH2wW4bLoZVYJj7","openStreetMaps":"https://www.openstreetmap.org/relation/14296"},"population":5458827,"gini":{"2018":25},"fifa":"SVK","car":{"signs":["SK"],"side":"right"},"timezones":["UTC+01:00"],"continents":["Europe"],"flags":{"png":"https://flagcdn.com/w320/sk.png","svg":"https://flagcdn.com/sk.svg"},"coatOfArms":{"png":"https://mainfacts.com/media/images/coats_of_arms/sk.png","svg":"https://mainfacts.com/media/images/coats_of_arms/sk.svg"},"startOfWeek":"monday","capitalInfo":{"latlng":[48.15,17.12]},"postalCode":{"format":"###  ##","regex":"^(\\d{5})$"}},{"name":{"common":"Latvia","official":"Republic of Latvia","nativeName":{"lav":{"official":"Latvijas Republikas","common":"Latvija"}}},"tld":[".lv"],"cca2":"LV","ccn3":"428","cca3":"LVA","cioc":"LAT","independent":true,"status":"officially-assigned","unMember":true,"currencies":{"EUR":{"name":"Euro","symbol":"€"}},"idd":{"root":"+3","suffixes":["71"]},"capital":["Riga"],"altSpellings":["LV","Republic of Latvia","Latvijas Republika"],"region":"Europe","subregion":"Northern Europe","languages":{"lav":"Latvian"},"translations":{"ara":{"official":"جمهورية لاتفيا","common":"لاتفيا"},"ces":{"official":"Lotyšská republika","common":"Lotyšsko"},"cym":{"official":"Republic of Latvia","common":"Latvia"},"deu":{"official":"Republik Lettland","common":"Lettland"},"est":{"official":"Läti Vabariik","common":"Läti"},"fin":{"official":"Latvian tasavalta","common":"Latvia"},"fra":{"official":"République de Lettonie","common":"Lettonie"},"hrv":{"official":"Republika Latvija","common":"Latvija"},"hun":{"official":"Lett Köztársaság","common":"Lettország"},"ita":{"official":"Repubblica di Lettonia","common":"Lettonia"},"jpn":{"official":"ラトビア共和国","common":"ラトビア"},"kor":{"official":"라트비아 공화국","common":"라트비아"},"nld":{"official":"Republiek Letland","common":"Letland"},"per":{"official":"جمهوری لتونی","common":"لتونی"},"pol":{"official":"Republika Łotewska","common":"Łotwa"},"por":{"official":"República da Letónia","common":"Letónia"},"rus":{"official":"Латвийская Республика","common":"Латвия"},"slk":{"official":"Lotyšská republika","common":"Lotyšsko"},"spa":{"official":"República de Letonia","common":"Letonia"},"swe":{"official":"Republiken Lettland","common":"Lettland"},"urd":{"official":"جمہوریہ لٹویا","common":"لٹویا"},"zho":{"official":"拉脱维亚共和国","common":"拉脱维亚"}},"latlng":[57,25],"landlocked":false,"borders":["BLR","EST","LTU","RUS"],"area":64559,"demonyms":{"eng":{"f":"Latvian","m":"Latvian"},"fra":{"f":"Lettone","m":"Letton"}},"flag":"🇱🇻","maps":{"googleMaps":"https://goo.gl/maps/iQpUkH7ghq31ZtXe9","openStreetMaps":"https://www.openstreetmap.org/relation/72594"},"population":1901548,"gini":{"2018":35.1},"fifa":"LVA","car":{"signs":["LV"],"side":"right"},"timezones":["UTC+02:00"],"continents":["Europe"],"flags":{"png":"https://flagcdn.com/w320/lv.png","svg":"https://flagcdn.com/lv.svg"},"coatOfArms":{"png":"https://mainfacts.com/media/images/coats_of_arms/lv.png","svg":"https://mainfacts.com/media/images/coats_of_arms/lv.svg"},"startOfWeek":"monday","capitalInfo":{"latlng":[56.95,24.1]},"postalCode":{"format":"LV-####","regex":"^(?:LV)*(\\d{4})$"}}]`

      console.log(
        dp.dataPipe().parseJson(
          '{v1:2, v2: 21}'
        )
      )

      // const iterator = dp.dataPipe()
      //   .jsonParseIterator('{v:{vi:test}, arr:{vi:test2}}');

      // for (let v of iterator) {
      //   console.log(v);
      // }
      // console.log(Array.from(iterator));
      return;

      // const mapFn = r => ({ val1: r });
      // const fdFn = (arr) => dp.dataPipe(arr.map(mapFn)).getFieldsInfo();

      // const data = fdFn([new Date(2001, 1, 1), new Date()]);

      const array = ['2021-05-01', null, '2021-05-01'];
      data = dp
        .dataPipe(array)
        .getFieldsInfo();

      console.log('==>', dp.dataPipe().rtrim('net.', '.'))

      // fetch("https://restcountries.eu/rest/v2/regionalbloc/eu")
      // .then(r => {
      //   r.json().then(items => {
      //     console.log('==>', items, dp.dataPipe(items).getFieldsInfo());
      //   });
      // })

    }

    onButtonClick();

    // fetch("https://raw.githubusercontent.com/FalconSoft/sample-data/master/CSV/sample-testing-data-100.csv")
    //   .then(r => {
    //     r.text().then(text => {
    //       const items = dp.dataPipe().fromCsv(text).toArray();
    //       console.log('==>', items, dp.dataPipe(items).getFieldDescriptions());
    //     });
    //   })

    // onButtonClick();

  </script>
</body>

</html>