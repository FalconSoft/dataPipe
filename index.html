<html>

<head>
  <title>Data Pipe JS</title>
  <script src="./dist/data-pipe.min.js"></script>

</head>

<body>
  <h4>Data Pipe testing page. Do not expect anything here! </h4>

  <button onclick="onButtonClick()">++ Click ++ </button>

  <input id="input" type="file" onchange="fileChange(this.files[0])" />

  <script>
    let result = null;
    let firstChar = '';

    function fileChange(file) {
      if (!file) {
        return;
      }
      firstChar = '';
      result = null;
      const parser = dp.dataPipe().JSONParser();

      iterateChunks(file, chunkText => {
        for (const ch of chunkText) {
          if (!firstChar) {
            firstChar = ch;
            result = ch === '[' ? [] : Object.create(null);
            continue;
          }
          parser.processFirstLevel(ch, (itemString, key) => {
            result.push(JSON.parse(itemString))            
          });
        }
      });

    }

    function iterateChunks(file, callback) {
      const chunkSize = 1024; // 10 * 64 * 64 * 1024;
      let offset = 0;
      const decoder = new TextDecoder();
      const fr = new FileReader();
      fr.onload = () => {
        const view = new Uint8Array(fr.result);
        const text = decoder.decode(view);
        callback(text);

        offset += chunkSize;
        seek();
      }
      fr.onerror = (err) => {
        console.log(err)
      };

      seek();

      function seek() {
        if (offset >= file.size) {
          console.log('==> done ==>', result)

          return;
        }

        const slice = file.slice(offset, offset + chunkSize);
        fr.readAsArrayBuffer(slice)
      }
    }

    function onButtonClick() {
      const json = `[{"name":{"common":"Belarus","official":"Republic of Belarus","nativeName":{"bel":{"official":"Ð ÑÑÐ¿ÑƒÐ±Ð»Ñ–ÐºÐ° Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÑŒ","common":"Ð‘ÐµÐ»Ð°Ñ€ÑƒÌÑÑŒ"},"rus":{"official":"Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÑŒ","common":"Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÑŒ"}}},"tld":[".by"],"cca2":"BY","ccn3":"112","cca3":"BLR","cioc":"BLR","independent":true,"status":"officially-assigned","unMember":true,"currencies":{"BYN":{"name":"Belarusian ruble","symbol":"Br"}},"idd":{"root":"+3","suffixes":["75"]},"capital":["Minsk"],"altSpellings":["BY","BielaruÅ›","Republic of Belarus","Ð‘ÐµÐ»Ð¾Ñ€ÑƒÑÑÐ¸Ñ","Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° Ð‘ÐµÐ»Ð¾Ñ€ÑƒÑÑÐ¸Ñ"],"region":"Europe","subregion":"Eastern Europe","languages":{"bel":"Belarusian","rus":"Russian"},"translations":{"ara":{"official":"Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø¨ÙŠÙ„Ø§Ø±ÙˆØ³ÙŠØ§","common":"Ø¨ÙŠÙ„Ø§Ø±ÙˆØ³ÙŠØ§"},"ces":{"official":"BÄ›loruskÃ¡ republika","common":"BÄ›lorusko"},"cym":{"official":"Gweriniaeth Belarws","common":"Belarws"},"deu":{"official":"Republik Belarus","common":"WeiÃŸrussland"},"est":{"official":"Valgevene Vabariik","common":"Valgevene"},"fin":{"official":"Valko-VenÃ¤jÃ¤n tasavalta","common":"Valko-VenÃ¤jÃ¤"},"fra":{"official":"RÃ©publique de BiÃ©lorussie","common":"BiÃ©lorussie"},"hrv":{"official":"Republika Bjelorusija","common":"Bjelorusija"},"hun":{"official":"FehÃ©rorosz KÃ¶ztÃ¡rsasÃ¡g","common":"FehÃ©roroszorszÃ¡g"},"ita":{"official":"Repubblica di Belarus","common":"Bielorussia"},"jpn":{"official":"ãƒ™ãƒ©ãƒ«ãƒ¼ã‚·å…±å’Œå›½","common":"ãƒ™ãƒ©ãƒ«ãƒ¼ã‚·"},"kor":{"official":"ë²¨ë¼ë£¨ìŠ¤ ê³µí™”êµ­","common":"ë²¨ë¼ë£¨ìŠ¤"},"nld":{"official":"Republiek Belarus","common":"Wit-Rusland"},"per":{"official":"Ø¬Ù…Ù‡ÙˆØ±ÛŒ Ø¨Ù„Ø§Ø±ÙˆØ³","common":"Ø¨Ù„Ø§Ø±ÙˆØ³"},"pol":{"official":"Republika BiaÅ‚orusi","common":"BiaÅ‚oruÅ›"},"por":{"official":"RepÃºblica da BielorrÃºssia","common":"BielorÃºssia"},"rus":{"official":"Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÑŒ","common":"Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÑŒ"},"slk":{"official":"BieloruskÃ¡ republika","common":"Bielorusko"},"spa":{"official":"RepÃºblica de BelarÃºs","common":"Bielorrusia"},"swe":{"official":"Republiken Vitryssland","common":"Belarus"},"urd":{"official":"Ø¬Ù…ÛÙˆØ±ÛŒÛ Ø¨ÛŒÙ„Ø§Ø±ÙˆØ³","common":"Ø¨ÛŒÙ„Ø§Ø±ÙˆØ³"},"zho":{"official":"ç™½ä¿„ç½—æ–¯å…±å’Œå›½","common":"ç™½ä¿„ç½—æ–¯"}},"latlng":[53,28],"landlocked":true,"borders":["LVA","LTU","POL","RUS","UKR"],"area":207600,"demonyms":{"eng":{"f":"Belarusian","m":"Belarusian"},"fra":{"f":"BiÃ©lorusse","m":"BiÃ©lorusse"}},"flag":"ðŸ‡§ðŸ‡¾","maps":{"googleMaps":"https://goo.gl/maps/PJUDU3EBPSszCQcu6","openStreetMaps":"https://www.openstreetmap.org/relation/59065"},"population":9398861,"gini":{"2019":25.3},"fifa":"BLR","car":{"signs":["BY"],"side":"right"},"timezones":["UTC+03:00"],"continents":["Europe"],"flags":{"png":"https://flagcdn.com/w320/by.png","svg":"https://flagcdn.com/by.svg"},"coatOfArms":{"png":"https://mainfacts.com/media/images/coats_of_arms/by.png","svg":"https://mainfacts.com/media/images/coats_of_arms/by.svg"},"startOfWeek":"monday","capitalInfo":{"latlng":[53.9,27.57]},"postalCode":{"format":"######","regex":"^(\\d{6})$"}},{"name":{"common":"Slovakia","official":"Slovak Republic","nativeName":{"slk":{"official":"SlovenskÃ¡ republika","common":"Slovensko"}}},"tld":[".sk"],"cca2":"SK","ccn3":"703","cca3":"SVK","cioc":"SVK","independent":true,"status":"officially-assigned","unMember":true,"currencies":{"EUR":{"name":"Euro","symbol":"â‚¬"}},"idd":{"root":"+4","suffixes":["21"]},"capital":["Bratislava"],"altSpellings":["SK","Slovak Republic","SlovenskÃ¡ republika"],"region":"Europe","subregion":"Central Europe","languages":{"slk":"Slovak"},"translations":{"ara":{"official":"Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø³Ù„ÙˆÙØ§ÙƒÙŠØ§","common":"Ø³Ù„ÙˆÙØ§ÙƒÙŠØ§"},"ces":{"official":"SlovenskÃ¡ republika","common":"Slovensko"},"cym":{"official":"Slovak Republic","common":"Slovakia"},"deu":{"official":"Slowakische Republik","common":"Slowakei"},"est":{"official":"Slovaki Vabariik","common":"Slovakkia"},"fin":{"official":"Slovakian tasavalta","common":"Slovakia"},"fra":{"official":"RÃ©publique slovaque","common":"Slovaquie"},"hrv":{"official":"slovaÄka","common":"SlovaÄka"},"hun":{"official":"SzlovÃ¡k KÃ¶ztÃ¡rsasÃ¡g","common":"SzlovÃ¡kia"},"ita":{"official":"Repubblica slovacca","common":"Slovacchia"},"jpn":{"official":"ã‚¹ãƒ­ãƒã‚­ã‚¢å…±å’Œå›½","common":"ã‚¹ãƒ­ãƒã‚­ã‚¢"},"kor":{"official":"ìŠ¬ë¡œë°”í‚¤ì•„ ê³µí™”êµ­","common":"ìŠ¬ë¡œë°”í‚¤ì•„"},"nld":{"official":"Slowaakse Republiek","common":"Slowakije"},"per":{"official":"Ø¬Ù…Ù‡ÙˆØ±ÛŒ Ø§Ø³Ù„ÙˆØ§Ú©ÛŒ","common":"Ø§ÙØ³Ù„ÙÙˆØ§Ú©ÛŒ"},"pol":{"official":"Republika SÅ‚owacka","common":"SÅ‚owacja"},"por":{"official":"RepÃºblica Eslovaca","common":"EslovÃ¡quia"},"rus":{"official":"Ð¡Ð»Ð¾Ð²Ð°Ñ†ÐºÐ°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°","common":"Ð¡Ð»Ð¾Ð²Ð°ÐºÐ¸Ñ"},"slk":{"official":"SlovenskÃ¡ republika","common":"Slovensko"},"spa":{"official":"RepÃºblica Eslovaca","common":"RepÃºblica Eslovaca"},"swe":{"official":"Republiken Slovakien","common":"Slovakien"},"urd":{"official":"Ø¬Ù…ÛÙˆØ±ÛŒÛ Ø³Ù„ÙˆÙˆØ§Ú©ÛŒÛ","common":"Ø³Ù„ÙˆÙˆØ§Ú©ÛŒÛ"},"zho":{"official":"æ–¯æ´›ä¼å…‹å…±å’Œå›½","common":"æ–¯æ´›ä¼å…‹"}},"latlng":[48.66666666,19.5],"landlocked":true,"borders":["AUT","CZE","HUN","POL","UKR"],"area":49037,"demonyms":{"eng":{"f":"Slovak","m":"Slovak"},"fra":{"f":"Slovaque","m":"Slovaque"}},"flag":"ðŸ‡¸ðŸ‡°","maps":{"googleMaps":"https://goo.gl/maps/uNSH2wW4bLoZVYJj7","openStreetMaps":"https://www.openstreetmap.org/relation/14296"},"population":5458827,"gini":{"2018":25},"fifa":"SVK","car":{"signs":["SK"],"side":"right"},"timezones":["UTC+01:00"],"continents":["Europe"],"flags":{"png":"https://flagcdn.com/w320/sk.png","svg":"https://flagcdn.com/sk.svg"},"coatOfArms":{"png":"https://mainfacts.com/media/images/coats_of_arms/sk.png","svg":"https://mainfacts.com/media/images/coats_of_arms/sk.svg"},"startOfWeek":"monday","capitalInfo":{"latlng":[48.15,17.12]},"postalCode":{"format":"###  ##","regex":"^(\\d{5})$"}},{"name":{"common":"Latvia","official":"Republic of Latvia","nativeName":{"lav":{"official":"Latvijas Republikas","common":"Latvija"}}},"tld":[".lv"],"cca2":"LV","ccn3":"428","cca3":"LVA","cioc":"LAT","independent":true,"status":"officially-assigned","unMember":true,"currencies":{"EUR":{"name":"Euro","symbol":"â‚¬"}},"idd":{"root":"+3","suffixes":["71"]},"capital":["Riga"],"altSpellings":["LV","Republic of Latvia","Latvijas Republika"],"region":"Europe","subregion":"Northern Europe","languages":{"lav":"Latvian"},"translations":{"ara":{"official":"Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ù„Ø§ØªÙÙŠØ§","common":"Ù„Ø§ØªÙÙŠØ§"},"ces":{"official":"LotyÅ¡skÃ¡ republika","common":"LotyÅ¡sko"},"cym":{"official":"Republic of Latvia","common":"Latvia"},"deu":{"official":"Republik Lettland","common":"Lettland"},"est":{"official":"LÃ¤ti Vabariik","common":"LÃ¤ti"},"fin":{"official":"Latvian tasavalta","common":"Latvia"},"fra":{"official":"RÃ©publique de Lettonie","common":"Lettonie"},"hrv":{"official":"Republika Latvija","common":"Latvija"},"hun":{"official":"Lett KÃ¶ztÃ¡rsasÃ¡g","common":"LettorszÃ¡g"},"ita":{"official":"Repubblica di Lettonia","common":"Lettonia"},"jpn":{"official":"ãƒ©ãƒˆãƒ“ã‚¢å…±å’Œå›½","common":"ãƒ©ãƒˆãƒ“ã‚¢"},"kor":{"official":"ë¼íŠ¸ë¹„ì•„ ê³µí™”êµ­","common":"ë¼íŠ¸ë¹„ì•„"},"nld":{"official":"Republiek Letland","common":"Letland"},"per":{"official":"Ø¬Ù…Ù‡ÙˆØ±ÛŒ Ù„ØªÙˆÙ†ÛŒ","common":"Ù„ØªÙˆÙ†ÛŒ"},"pol":{"official":"Republika Åotewska","common":"Åotwa"},"por":{"official":"RepÃºblica da LetÃ³nia","common":"LetÃ³nia"},"rus":{"official":"Ð›Ð°Ñ‚Ð²Ð¸Ð¹ÑÐºÐ°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°","common":"Ð›Ð°Ñ‚Ð²Ð¸Ñ"},"slk":{"official":"LotyÅ¡skÃ¡ republika","common":"LotyÅ¡sko"},"spa":{"official":"RepÃºblica de Letonia","common":"Letonia"},"swe":{"official":"Republiken Lettland","common":"Lettland"},"urd":{"official":"Ø¬Ù…ÛÙˆØ±ÛŒÛ Ù„Ù¹ÙˆÛŒØ§","common":"Ù„Ù¹ÙˆÛŒØ§"},"zho":{"official":"æ‹‰è„±ç»´äºšå…±å’Œå›½","common":"æ‹‰è„±ç»´äºš"}},"latlng":[57,25],"landlocked":false,"borders":["BLR","EST","LTU","RUS"],"area":64559,"demonyms":{"eng":{"f":"Latvian","m":"Latvian"},"fra":{"f":"Lettone","m":"Letton"}},"flag":"ðŸ‡±ðŸ‡»","maps":{"googleMaps":"https://goo.gl/maps/iQpUkH7ghq31ZtXe9","openStreetMaps":"https://www.openstreetmap.org/relation/72594"},"population":1901548,"gini":{"2018":35.1},"fifa":"LVA","car":{"signs":["LV"],"side":"right"},"timezones":["UTC+02:00"],"continents":["Europe"],"flags":{"png":"https://flagcdn.com/w320/lv.png","svg":"https://flagcdn.com/lv.svg"},"coatOfArms":{"png":"https://mainfacts.com/media/images/coats_of_arms/lv.png","svg":"https://mainfacts.com/media/images/coats_of_arms/lv.svg"},"startOfWeek":"monday","capitalInfo":{"latlng":[56.95,24.1]},"postalCode":{"format":"LV-####","regex":"^(?:LV)*(\\d{4})$"}}]`

      console.log(
        dp.dataPipe().parseJson(
          '{v1:2, v2: 21}'
        )
      )

      // const iterator = dp.dataPipe()
      //   .jsonParseIterator('{v:{vi:test}, arr:{vi:test2}}');

      // for (let v of iterator) {
      //   console.log(v);
      // }
      // console.log(Array.from(iterator));
      return;

      // const mapFn = r => ({ val1: r });
      // const fdFn = (arr) => dp.dataPipe(arr.map(mapFn)).getFieldsInfo();

      // const data = fdFn([new Date(2001, 1, 1), new Date()]);

      const array = ['2021-05-01', null, '2021-05-01'];
      data = dp
        .dataPipe(array)
        .getFieldsInfo();

      console.log('==>', dp.dataPipe().rtrim('net.', '.'))

      // fetch("https://restcountries.eu/rest/v2/regionalbloc/eu")
      // .then(r => {
      //   r.json().then(items => {
      //     console.log('==>', items, dp.dataPipe(items).getFieldsInfo());
      //   });
      // })

    }

    onButtonClick();

    // fetch("https://raw.githubusercontent.com/FalconSoft/sample-data/master/CSV/sample-testing-data-100.csv")
    //   .then(r => {
    //     r.text().then(text => {
    //       const items = dp.dataPipe().fromCsv(text).toArray();
    //       console.log('==>', items, dp.dataPipe(items).getFieldDescriptions());
    //     });
    //   })

    // onButtonClick();

  </script>
</body>

</html>